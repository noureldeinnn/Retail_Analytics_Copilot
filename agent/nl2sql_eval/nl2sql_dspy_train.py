"""
Train a DSPy NL→SQL module (only for NL→SQL) using a tiny supervised set.

Goals:
- Fix specific baseline issues:
  * Missing JOIN to Customers (q09).
  * Wrong column p.Discount instead of od.Discount (q10).
  * Multiple statements / 'SQL:' prefix (q16).
- Reinforce correct patterns for revenue, counts, and joins.

After training, we get an optimized NL2SQLModule which we can use as:

    optimized_nl2sql(question=..., schema=..., doc_context=...).sql

We then wrap this in generate_sql_dspy(...) and plug it into:
  - nl2sql_baseline_eval (for AFTER metrics),
  - graph_hybrid.nl2sql_node (to upgrade the real agent).
"""

from typing import List

import dspy

from agent.dspy_signatures import NL2SQLModule
from agent.tools import sqlite_tool
from agent.graph_hybrid import _clean_sql_output
import os

# ---------- 1. Configure DSPy LM to use your Ollama model ----------

# This config is process-wide; call once per process.
lm = dspy.LM(
    "ollama_chat/phi3.5:3.8b-mini-instruct-q4_K_M",
    api_base="http://localhost:11434",  # default Ollama endpoint
    api_key="",                         # Ollama does not require an API key
    temperature=0.1,                    # low temp for more deterministic SQL
    max_tokens=512,
)
dspy.configure(lm=lm)


# ---------- 2. Build a tiny trainset with CORRECT SQL ----------

def build_train_examples() -> List[dspy.Example]:
    """
    Build a handcrafted NL→SQL training set (15 examples).
    Covers:
      - Counting
      - Aggregation
      - Revenue formula
      - Missing JOIN fixes
      - Category filtering
      - Date filtering
      - GROUP BY patterns
      - High/low sorting queries

    All SQL is valid for Northwind SQLite.
    """
    schema_str = sqlite_tool.get_schema()
    examples = []

    # --- Example 1 ---
    examples.append(
        dspy.Example(
            question="How many customers are there in the database?",
            schema=schema_str,
            doc_context="Count rows in the Customers table.",
            sql=(
                "SELECT COUNT(*) AS NumCustomers "
                "FROM Customers;"
            ),
        ).with_inputs("question", "schema", "doc_context")
    )

    # --- Example 2 ---
    examples.append(
        dspy.Example(
            question="What is the total number of orders recorded in the Orders table?",
            schema=schema_str,
            doc_context="Count rows in Orders.",
            sql=(
                "SELECT COUNT(*) AS TotalOrders "
                "FROM Orders;"
            ),
        ).with_inputs("question", "schema", "doc_context")
    )

    # --- Example 3 ---
    examples.append(
        dspy.Example(
            question="Which product has the highest unit price?",
            schema=schema_str,
            doc_context="Sort Products by UnitPrice descending.",
            sql=(
                "SELECT ProductName "
                "FROM Products "
                "ORDER BY UnitPrice DESC "
                "LIMIT 1;"
            ),
        ).with_inputs("question", "schema", "doc_context")
    )

    # --- Example 4 ---
    examples.append(
        dspy.Example(
            question="What is the average unit price of all products?",
            schema=schema_str,
            doc_context="Use AVG(UnitPrice) over Products.",
            sql=(
                "SELECT AVG(UnitPrice) AS AverageUnitPrice "
                "FROM Products;"
            ),
        ).with_inputs("question", "schema", "doc_context")
    )

    # --- Example 5 ---
    examples.append(
        dspy.Example(
            question="What is the total revenue for all orders? Use SUM(UnitPrice * Quantity * (1 - Discount)).",
            schema=schema_str,
            doc_context="Revenue formula uses Order Details table.",
            sql=(
                "SELECT SUM(od.UnitPrice * od.Quantity * (1 - od.Discount)) AS TotalRevenue "
                "FROM Orders o "
                "JOIN \"Order Details\" od ON o.OrderID = od.OrderID;"
            ),
        ).with_inputs("question", "schema", "doc_context")
    )

    # --- Example 6 (fix missing JOIN from baseline q09) ---
    examples.append(
        dspy.Example(
            question="Which customer placed the most orders? Return CustomerID.",
            schema=schema_str,
            doc_context="Count Orders grouped by CustomerID.",
            sql=(
                "SELECT o.CustomerID "
                "FROM Orders o "
                "GROUP BY o.CustomerID "
                "ORDER BY COUNT(*) DESC "
                "LIMIT 1;"
            ),
        ).with_inputs("question", "schema", "doc_context")
    )

    # --- Example 7 (fix wrong p.Discount from baseline q10) ---
    examples.append(
        dspy.Example(
            question="What is the total revenue generated by the 'Beverages' category?",
            schema=schema_str,
            doc_context="Use Categories.CategoryName = 'Beverages'.",
            sql=(
                "SELECT SUM(od.UnitPrice * od.Quantity * (1 - od.Discount)) AS TotalRevenue "
                "FROM Orders o "
                "JOIN \"Order Details\" od ON o.OrderID = od.OrderID "
                "JOIN Products p ON od.ProductID = p.ProductID "
                "JOIN Categories c ON p.CategoryID = c.CategoryID "
                "WHERE c.CategoryName = 'Beverages';"
            ),
        ).with_inputs("question", "schema", "doc_context")
    )

    # --- Example 8 (fix multi-statement hallucination q16) ---
    examples.append(
        dspy.Example(
            question="How many orders were placed in 1997?",
            schema=schema_str,
            doc_context="Filter Orders using strftime date range.",
            sql=(
                "SELECT COUNT(*) AS NumberOfOrders "
                "FROM Orders "
                "WHERE strftime('%Y-%m-%d', OrderDate) BETWEEN '1997-01-01' AND '1997-12-31';"
            ),
        ).with_inputs("question", "schema", "doc_context")
    )

    # --- Example 9 ---
    examples.append(
        dspy.Example(
            question="Which category has the most products?",
            schema=schema_str,
            doc_context="Join Categories to Products and count ProductID.",
            sql=(
                "SELECT c.CategoryName "
                "FROM Categories c "
                "JOIN Products p ON c.CategoryID = p.CategoryID "
                "GROUP BY c.CategoryID "
                "ORDER BY COUNT(p.ProductID) DESC "
                "LIMIT 1;"
            ),
        ).with_inputs("question", "schema", "doc_context")
    )

    # --- Example 10 ---
    examples.append(
        dspy.Example(
            question="How many orders were shipped to Germany?",
            schema=schema_str,
            doc_context="Filter Orders by ShipCountry = 'Germany'.",
            sql=(
                "SELECT COUNT(*) AS NumOrders "
                "FROM Orders "
                "WHERE ShipCountry = 'Germany';"
            ),
        ).with_inputs("question", "schema", "doc_context")
    )

    # --- Example 11 ---
    examples.append(
        dspy.Example(
            question="List all products with unit price greater than 50.",
            schema=schema_str,
            doc_context="Filter Products.UnitPrice > 50.",
            sql=(
                "SELECT ProductID, ProductName, UnitPrice "
                "FROM Products "
                "WHERE UnitPrice > 50;"
            ),
        ).with_inputs("question", "schema", "doc_context")
    )

    # --- Example 12 ---
    examples.append(
        dspy.Example(
            question="Which employee processed the most orders?",
            schema=schema_str,
            doc_context="Group Orders by EmployeeID.",
            sql=(
                "SELECT EmployeeID "
                "FROM Orders "
                "GROUP BY EmployeeID "
                "ORDER BY COUNT(*) DESC "
                "LIMIT 1;"
            ),
        ).with_inputs("question", "schema", "doc_context")
    )

    # --- Example 13 ---
    examples.append(
        dspy.Example(
            question="Which product has the highest total revenue across all time?",
            schema=schema_str,
            doc_context="Use SUM(UnitPrice*Quantity*(1-Discount)) grouped by product.",
            sql=(
                "SELECT p.ProductName, "
                "SUM(od.UnitPrice * od.Quantity * (1 - od.Discount)) AS TotalRevenue "
                "FROM Orders o "
                "JOIN \"Order Details\" od ON o.OrderID = od.OrderID "
                "JOIN Products p ON od.ProductID = p.ProductID "
                "GROUP BY p.ProductName "
                "ORDER BY TotalRevenue DESC "
                "LIMIT 1;"
            ),
        ).with_inputs("question", "schema", "doc_context")
    )

    # --- Example 14 ---
    examples.append(
        dspy.Example(
            question="How many distinct countries have customers?",
            schema=schema_str,
            doc_context="Use COUNT(DISTINCT Country) from Customers.",
            sql=(
                "SELECT COUNT(DISTINCT Country) AS NumCountries "
                "FROM Customers;"
            ),
        ).with_inputs("question", "schema", "doc_context")
    )

    # --- Example 15 ---
    examples.append(
        dspy.Example(
            question="What is the total quantity sold of the Condiments category?",
            schema=schema_str,
            doc_context="Filter Categories.CategoryName='Condiments'.",
            sql=(
                "SELECT SUM(od.Quantity) AS TotalQuantity "
                "FROM Orders o "
                "JOIN \"Order Details\" od ON o.OrderID = od.OrderID "
                "JOIN Products p ON od.ProductID = p.ProductID "
                "JOIN Categories c ON p.CategoryID = c.CategoryID "
                "WHERE c.CategoryName = 'Condiments';"
            ),
        ).with_inputs("question", "schema", "doc_context")
    )

    return examples



# ---------- 3. Optimize NL2SQLModule ----------

def train_nl2sql_with_dspy() -> NL2SQLModule:
    """
    Train an NL2SQLModule with BootstrapFewShot on the tiny supervised set.
    Returns the optimized NL2SQLModule program.
    """
    trainset = build_train_examples()
    print(f"[DSPy] Training NL2SQL on {len(trainset)} examples...")

    base_module = NL2SQLModule()

    # BootstrapFewShot chooses a subset of examples as in-context demos
    optimizer = dspy.BootstrapFewShot(k=12)

    optimized_module = optimizer.compile(
        base_module,
        trainset=trainset,
    )

    print("[DSPy] Training complete.")
    return optimized_module


# ---------- 4. Cached accessor + generate_sql_dspy wrapper ----------

_nl2sql_prog: NL2SQLModule | None = None


def get_nl2sql_prog() -> NL2SQLModule:
    """
    Lazily train (or return cached) optimized NL2SQL DSPy program.
    This avoids retraining on every import/call.
    """
    global _nl2sql_prog
    if _nl2sql_prog is None:
        _nl2sql_prog = train_nl2sql_with_dspy()
    return _nl2sql_prog


def generate_sql_dspy(question: str, doc_context: str = "") -> str:
    """
    DSPy-backed SQL generator that mirrors the behavior of generate_sql,
    but uses the optimized NL2SQLModule.

    This is intended as a drop-in replacement for the baseline generate_sql(...)
    in:
      - nl2sql_baseline_eval (for AFTER metrics),
      - graph_hybrid.nl2sql_node (for the real hybrid agent).
    """
    schema = sqlite_tool.get_schema()
    prog = get_nl2sql_prog()
    pred = prog(question=question, schema=schema, doc_context=doc_context)
    return _clean_sql_output(pred.sql)


# ---------- 5. Simple manual test ----------

if __name__ == "__main__":
    # 1. Train or load
    prog = get_nl2sql_prog()

    # 2. Save trained program
    HERE = os.path.dirname(__file__)
    MODEL_DIR = os.path.join(HERE, "nl2sql_prog")  # directory, not file
    os.makedirs(MODEL_DIR, exist_ok=True)
    prog.save(MODEL_DIR, save_program=True)
    print(f"Saved optimized DSPy NL2SQL program to: {MODEL_DIR}")

    # 3. Manual sanity tests
    schema = sqlite_tool.get_schema()
    tests = [
        "Which customer placed the most orders? Return CustomerID.",
        "What is the total revenue generated by the 'Beverages' category?",
        "How many orders were placed in 1997?",
    ]

    for q in tests:
        sql = generate_sql_dspy(q, doc_context="")
        print("\nQ:", q)
        print("SQL (DSPy cleaned):")
        print(sql)
